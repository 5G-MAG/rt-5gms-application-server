5G-MAG Reference Tools: 5GMS Application Server - Development
=============================================================

In this directory you will find files to assist with development and testing of
the 5G-MAG Reference Tools 5GMS Application Server (AS).

Files in this repository:
- README.md      - Project README file.
- ATTRIBUTION_NOTICE - List of 3rd party software used when running the 5GMS application server.
- LICENSE        - The software license for this project.
- pyproject.toml - The Python project description for building and installing the application.
- build_scripts/ - Scripts used when building the python project.
  - backend.py - build backend wrapper to trigger extra build actions.
  - generate_5gms_as_openapi - Will generate the OpenAPI python modules if not already present.
- docs/          - Development documentation and examples.
  - README.md - This document.
  - example-application-server.conf - A template application-server.conf file.
- external/      - mount point for external submodules.
  - rt-common-shared/  - The 5G-MAG/rt-common-shared submodule which contains the example files used in this README.
- src/           - The application source modules.
  - rt_5gms_as - The main Python module for this application
    - app.py - Application entry point.
    - context.py - Python module contaioning the Context class which is used to hold and manipulate the application server context.
    - openapi_5g - Python bindings generated by openapi-generator-cli from the 5G APIs. Note: This directory is not present in the tree until `build_scripts/generate_5gms_as_openapi` is run.
    - proxy_factory.py - Factory module to pick a suitable web server/proxy.
    - proxies/ - Contains the web server/proxy detection and configuration classes and any data files they need.
    - utils.py - Common utility functions for the web server/proxy classes.
- tests/         - Regression and build acceptance tests.

Running the example without building
------------------------------------
Make sure that git, java, wget and nginx are installed on the local system and
can be found on the current command path (`$PATH`).

Generate the OpenAPI python modules (these are not part of the source
distribution):
```
cd rt-5gms-application-server
build_scripts/generate_openapi
```

Create a configuration to run the application server as a local, unprivileged,
user.
```
mkdir ~/.rt_5gms
cat > ~/.rt_5gms/application-server.conf <<EOF
[DEFAULT]
log_dir = /tmp/rt-5gms-as/logs
run_dir = /tmp/rt-5gms-as

### 5GMS Application Server specific configurations
[5gms_as]
cache_dir = /tmp/rt-5gms-as/cache
http_port = 8080
https_port = 8443

### 5GMS Application Server nginx specific configuration
[5gms_as.nginx]
root_temp = /tmp/rt-5gms-as
EOF
mkdir -p /tmp/rt-5gms-as/cache
mkdir /tmp/rt-5gms-as/logs
```

Run the example directly:
```
cd rt-5gms-application-server/src
python3 -m rt_5gms_as.app ../external/rt-common-shared/5gms/examples/ContentHostingConfiguration_Big-Buck-Bunny_pull-ingest.json
```

This will start nginx with a configuration which will provide a reverse proxy to the Big Buck Bunny DASH media at <http://localhost:8080/m4d/provisioning-session-d54a1fcc-d411-4e32-807b-2c60dbaeaf5f/BigBuckBunny_4s_onDemand_2014_05_09.mpd>.

### Run using an HTTPS distribution configuration
To start an HTTPS service to host the Big Buck Bunny DASH media run the https or http_and_https example.

First the certificates need to be created for localhost, e.g. (requires openssl 1.1.1 or later to be installed):
```
cd rt-5gms-application-server/external/rt-common-shared/5gms
scripts/make_self_signed_certs.py examples/ContentHostingConfiguration_Big-Buck-Bunny_pull-ingest_https.json examples/Certificates.json
```

Then the application server can be run with the ContentHostingConfiguration and matching Certificates JSON file, e.g.:
```
cd rt-5gms-application-server/src
python3 -m rt_5gms_as.app ../external/rt-common-shared/5gms/examples/ContentHostingConfiguration_Big-Buck-Bunny_pull-ingest_https.json ../external/rt-common-shared/5gms/examples/Certificates.json
```
...or for both HTTP and HTTPS distributions from localhost you can use the other ContentHostingConfiguration file.
```
cd rt-5gms-application-server/src
python3 -m rt_5gms_as.app ../external/rt-common-shared/5gms/examples/ContentHostingConfiguration_Big-Buck-Bunny_pull-ingest_http_and_https.json ../external/rt-common-shared/5gms/examples/Certificates.json
```

Note: Following these instructions will create a self-signed certificate for localhost in `rt-5gms-application-server/external/rt-common-shared/5gms/examples/certificate-1.pem`, this certificate will not pass CA verification so to access the URL you need to turn off SSL validation or accept the self-signed certificate in your browser.

Regenerating the 5G API bindings
--------------------------------
The `build_scripts/generate_openapi` script will use wget, git and java to
download the openapi-generator tool, the 5G OpenAPI YAML and generate the `rt_5gms_as.openapi_5g` Python module package. The script will only do this if the
`src/rt_5gms_as/openapi_5g` directory does not already exist.

Therefore to regenerate the API bindings you first need to remove the old bindings:
```
cd rt-5gms-application-server
rm -rf src/rt_5gms_as/openapi_5g
```

Then run the generator script:
```
rt-5gms-application-server/build_scripts/generate_openapi
```

For reference (or if it is desirable to recreate the steps manually) the `generate_openapi` script performs the following actions:
- Uses `wget` to fetch version 6.0.1 of the [openapi-generator-cli](https://github.com/OpenAPITools/openapi-generator-cli).
  - e.g. `wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/6.0.1/openapi-generator-cli-6.0.1.jar -O openapi-generator-cli.jar`
- Uses `git` to clone the [5G OpenAPI repository](https://forge.3gpp.org/rep/all/5G_APIs.git).
  - e.g. `git clone -b REL-17 https://forge.3gpp.org/rep/all/5G_APIs.git`
- Uses the openapi-generator-cli, downloaded in the first step, to generate the API bindings.
  - e.g. `mkdir 5g-api-python; java -jar openapi-generator-cli.jar generate -i 5G_APIs/TS26512_M1_ContentHostingProvisioning.yaml -g python --additional-properties packageName=rt_5gms_as.openapi_5g,projectName=openapi-5g -o 5g-api-python`
- Copies the API Python package to the `src/rt_5gms_as/openapi_5g` directory.
  - e.g. `cp -r 5g-api-python/rt_5gms_as/openapi_5g rt-5gms-application-server/src/rt_5gms_as/`

