5G-MAG Reference Tools: 5GMS Application Server - Development
=============================================================

In this directory you will find files to assist with development and testing of
the 5G-MAG Reference Tools 5GMS Application Server (AS).

Files in this repository:
- ATTRIBUTION_NOTICE - Project run-time attributions
- LICENSE            - The software license for this project.
- README.md          - Project README file.
- pyproject.toml     - The Python project description for building and installing the application.
- build_scripts/     - Scripts used when building the python project.
  - backend.py - build backend wrapper to trigger extra build actions.
  - generate_5gms_as_openapi - Will generate the OpenAPI python modules if not already present.
- docs/              - Development documentation and examples.
  - README.md - This document.
  - example-application-server.conf - An application configuration which documents the defaults and meaning for each application configuration option.
- external/          - Directory containing submodule mount points.
  - rt-common-shared/ - The common shared examples and scripts.
- src/               - The application source modules.
  - rt_5gms_as/ - The main Python module for this application
    - app.py - Application entry point.
    - context.py - module for the application Context class.
    - openapi_5g/ - Python bindings generated by openapi-generator-cli from the 5G APIs. Note: This directory is not present in the tree until `build_scripts/generate_openapi` is run.
    - proxy_factory.py - Factory module to pick a suitable web server/proxy.
    - proxies/ - Contains the web server/proxy detection and configuration classes and any data files they need.
    - utils.py - Common utility functions for the web server/proxy classes.
- tests/         - Regression and build acceptance tests.

Running the example without building
------------------------------------
Make sure that git, java, wget and nginx are installed on the local system and
can be found on the current command path (`$PATH`):
```
sudo apt install git wget nginx default-jdk python3-regex
```

Generate the OpenAPI python modules (these are not part of the source
distribution). Read documentation below on "Regenerating the 5G API bindings":
```
cd ~/rt-5gms-application-server
build_scripts/generate_5gms_as_openapi
```

Create a configuration to run the application server as a local, unprivileged,
user.
```
mkdir ~/.rt_5gms
cat > ~/.rt_5gms/application-server.conf <<EOF
[DEFAULT]
log_dir = /tmp/rt-5gms-as/logs
run_dir = /tmp/rt-5gms-as

### 5GMS Application Server specific configurations
[5gms_as]
cache_dir = /tmp/rt-5gms-as/cache
http_port = 8080
https_port = 8443

### 5GMS Application Server nginx specific configuration
[5gms_as.nginx]
root_temp = /tmp/rt-5gms-as
EOF
mkdir -p /tmp/rt-5gms-as/cache
mkdir /tmp/rt-5gms-as/logs
```

Run the example directly:
```
cd ~/rt-5gms-application-server/src
python3 -m rt_5gms_as.app ../external/rt-common-shared/5gms/examples/ContentHostingConfiguration_Big-Buck-Bunny_pull-ingest.json
```

This will start nginx with a configuration which will provide a reverse proxy to the Big Buck Bunny DASH media at <http://localhost:8080/m4d/provisioning-session-d54a1fcc-d411-4e32-807b-2c60dbaeaf5f/BigBuckBunny_4s_onDemand_2014_05_09.mpd>.

Regenerating the 5G API bindings
--------------------------------
The `build_scripts/generate_5gms_as_openapi` script will use wget, git and java to download the openapi-generator tool, the 5G OpenAPI YAML and generate the `rt_5gms_as.openapi_5g` Python module package. The script will only do this if the `src/rt_5gms_as/openapi_5g` directory does not already exist.

Therefore to regenerate the API bindings you first need to remove the old bindings:
```
cd ~/rt-5gms-application-server
rm -rf src/rt_5gms_as/openapi_5g
```

Then run the generator script:
```
rt-5gms-application-server/build_scripts/generate_5gms_as_openapi
```

For reference (or if it is desirable to recreate the steps manually) the `generate_5gms_as_openapi` script performs the following actions:
- Uses `wget` to fetch version 6.0.1 of the [openapi-generator-cli](https://github.com/OpenAPITools/openapi-generator-cli).
  - e.g. `wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/6.0.1/openapi-generator-cli-6.0.1.jar -O openapi-generator-cli.jar`
- Uses `git` to clone the [5G OpenAPI repository](https://forge.3gpp.org/rep/all/5G_APIs.git).
  - e.g. `git clone -b REL-17 https://forge.3gpp.org/rep/all/5G_APIs.git`
- Uses the openapi-generator-cli, downloaded in the first step, to generate the API bindings.
  - e.g. `mkdir 5g-api-python; java -jar openapi-generator-cli.jar generate -i 5G_APIs/TS26512_M1_ContentHostingProvisioning.yaml -g python --additional-properties packageName=rt_5gms_as.openapi_5g,projectName=openapi-5g -o 5g-api-python`
- Copies the API Python package to the `src/rt_5gms_as/openapi_5g` directory.
  - e.g. `cp -r 5g-api-python/rt_5gms_as/openapi_5g rt-5gms-application-server/src/rt_5gms_as/`

